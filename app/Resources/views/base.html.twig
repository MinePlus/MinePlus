<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>{% block title %}{{ 'title'|trans }}{% endblock %}</title>
        {% block stylesheets %}
            <link rel="stylesheet" type="text/css" href="{{ asset('css/bootstrap.min.css') }}" />
        {% endblock %}
        
        {# For context-specific styles #}
        <style type="text/css">
            {% block styles %}
                .chat-log {
                    height: 85%;
                    overflow-y: scroll;
                }
                .chat-input {
                    padding: 10px;
                }
            {% endblock %}
        </style>
    </head>
    <body class="{% block body_class %}{% endblock %}">
        {% block body %}
            {% block navbar %}
                <div class="navbar">
                    <a class="navbar-brand" href="#">{{ 'navbar.application'|trans }}</a>
                    <ul class="nav navbar-nav">
                        {# 
                            TODO: normally this should only be used for debugging,
                            we'll find a better/safer checking mechanism!
                        #}
                        <li{% if app.request.get('_route') == 'dashboard' %} class="active"{% endif %}>
                            <a href="{{ path('dashboard') }}">{{ 'navbar.dashboard'|trans }}</a>
                        </li>
                    </ul>
                    {% if is_granted('ROLE_USER') %}
                        <ul class="nav navbar-nav pull-right">
                            <li class="dropdown">
                                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                                    {% if config.navbar.avatar.show %}
                                        {{ avatar(app.user.username, config.navbar.avatar.size)|raw }}
                                    {% endif %}
                                    {{ app.user.username }}
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a href="{{ path('fos_user_security_logout') }}">Logout</a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                        <a class="btn navbar-btn btn-primary pull-right disabled chat-indicator" data-toggle="modal" href="#chat-modal">Chat</a>
                    {% else %}
                        <a class="btn navbar-btn btn-default pull-right" href="{{ path('fos_user_security_login') }}">Login</a>
                    {% endif %}
                </div>
            {% endblock %}
            <div class="row">
                <div class="col-lg-11 col-offset-1">
                    {% block content %}
                    {% endblock %}
                </div>
            </div>
            {% block chat %}
                <div class="modal fade" id="chat-modal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title">Chat</h4>
                            </div>
                            <div class="modal-body">
                                <div class="chat-log">
                                </div>
                                <div class="chat-input row">
                                    <div class="col-lg-10">
                                        <textarea class="form-control" rows="2" id="chat-textarea"></textarea>
                                    </div>
                                    <div class="col-lg-2">
                                        <a class="btn btn-default disabled" id="chat-send">Send</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endblock %}
            {% block footer %}
                {# TODO: that's for the future ;) #}
            {% endblock %}
        {% endblock %}
        {% block javascripts %}
            <script type="text/javascript" src="{{ asset('js/jquery.min.js') }}"></script>
            <script type="text/javascript" src="{{ asset('js/bootstrap.min.js') }}"></script>
            {{ clank_client() }}
            <script type="text/javascript" src="{{ asset('js/script.js') }}"></script>
            <script type="text/javascript">
                $(document).ready(function() {
                    rescaleChat();
                    
                    var url = 'ws://{{ clank_host }}:{{ clank_port }}';
                    
                    var ws = Clank.connect(url);
                    
                    ws.on('socket/connect', function(session) {
                        setIndicator(true);
                        
                        session.subscribe('chat/channel/public', function(uri, payload) {
                            message(payload.msg);
                        });
                        
                        $('#chat-send').click(function () {
                            session.publish('chat/channel/public', {msg: $('#chat-textarea').val()});
                            $('#chat-textarea').val('');
                            $('#chat-send').addClass('disabled');
                        });
                    });
                    
                    ws.on('socket/disconnect', function(error) {
                        setIndicator(false);
                    });
                    
                    $('#chat-textarea').bind('input propertychange', function() {
                        if (this.value.length === 0) {
                            $('#chat-send').addClass('disabled');
                        } else {
                            if ($('#chat-send').hasClass('disabled')) {
                                $('#chat-send').removeClass('disabled');
                            }
                        }
                    });
                    
                });
            </script>
        {% endblock %}
    </body>
</html>
